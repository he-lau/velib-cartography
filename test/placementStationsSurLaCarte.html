<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Placement des stations</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>
    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js" integrity="sha512-OFs3W4DIZ5ZkrDhBFtsCP6JXtMEDGmhl0QPlmWYBJay40TT1n3gt2Xuw8Pf/iezgW9CdabjkNChRqozl/YADmg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.maptiler.com/maptiler-sdk-js/v1.1.1/maptiler-sdk.umd.js"></script>
    <link href="https://cdn.maptiler.com/maptiler-sdk-js/v1.1.1/maptiler-sdk.css" rel="stylesheet" />
    <script src="https://cdn.maptiler.com/leaflet-maptilersdk/v1.0.0/leaflet-maptilersdk.js"></script>
    <!-- Leaflet.MarkerCluster -->
    <script src='https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js'></script>
    <link href='https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css' rel='stylesheet' />
    <link href='https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css' rel='stylesheet' />

    <!-- FA 5-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">

    <style>
        #map { 
            height: 580px; 
        }
    </style>
</head>
<body>
    

    <div id="map"></div>

    <script>
        function initMap(elementId,lat,lon) {

            let map = L.map(elementId).setView([lat, lon], 18);
            
            // Charger les données depuis openstreetmap
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 20, // niveau de zoom max pour l'user
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            return map;
        }

        async function getUserCoordonnees() {

            // promesse pour resoudre geolocalisation
            return new Promise((resolve, reject) => {
                // si l'API est dispo sur le navigateur
                if ("geolocation" in navigator) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        const latitude = position.coords.latitude;
                        const longitude = position.coords.longitude;
                        const location = { lat: latitude, lon: longitude };
                        //console.log(location);

                        // resout avec pos
                        resolve(location);
                    }, function(error) {
                        console.error(error);
                        reject(error);
                    });
                } else {
                    console.error("Geolocation non disponible.");
                    reject("Geolocation non disponible");
                }
            });
        }


    </script>

    <script>

        let userLocation = {};

        let markers = L.markerClusterGroup();

        let map;
        let mapInitialized = false;

        const BASE_URL = "https://opendata.paris.fr/api/explore/v2.1/catalog/datasets/velib-disponibilite-en-temps-reel";

        const main = async () => {

            try {

                // Appel de la fonction getUserCoordonnees de manière asynchrone
                await getUserCoordonnees()
                    .then(location => {
                        console.log('test', location.lon);
                        // Utilisez les coordonnées de l'utilisateur ici, par exemple, mettez-les sur la carte       

                        // init leaflet map
                        map = initMap('map',location.lat,location.lon);   
                        mapInitialized = true;

                        console.log('BBBBBBBBBBBBBBB')
                        
                        // ajout du marqueur à la liste des marqueurs
                        let userPositionMarker = L.marker([location.lat, location.lon], {
                            icon: L.divIcon({
                                className: 'custom-icon', // Classe CSS personnalisée pour le marqueur
                                html: '<i class="fas fa-map-marker-alt" style="color: red;font-size:32px"></i>', // Contenu HTML du marqueur (Ici, une icône de marqueur rouge)
                                iconSize: [24, 24] // Taille personnalisée du marqueur en pixels (largeur, hauteur)
                            })
                        });

                        userPositionMarker.bindPopup("User location");
                        markers.addLayer(userPositionMarker);
                    }) // reject
                    .catch(error => {
                        console.error(error);
                    });     
                    
                    
                if(! mapInitialized) {
                    console.log('mapInitialized',mapInitialized);
                    // init leaflet map
                    map = initMap('map',48.833314,.3520025);    
                }
                



                const response = await fetch(BASE_URL+"/exports/json");
                const text = await response.text();

                let data = await JSON.parse(text);
                console.log(data);
                
                
                data.forEach(element => {
                    let stationcode = element["stationcode"];
                    let coordonnees_geo = element["coordonnees_geo"];
                    let lon = coordonnees_geo['lon'];
                    let lat = coordonnees_geo['lat'];
                    let capacity = element['capacity'];
                    let duedate = element['duedate'];
                    let ebike = element['ebike'];
                    let is_installed = element['is_installed'];
                    let is_renting = element['is_renting'];
                    let is_returning = element['is_returning'];
                    let mechanical = element['mechanical'];
                    let name = element['name'];
                    let nom_arrondissement_communes = element['nom_arrondissement_communes'];
                    let numbikesavailable = element['numbikesavailable'];
                    let numdocksavailable = element['numdocksavailable'];



                    //console.log("stationcode : ", stationcode);
                    //console.log("coordonnees_geo : ", coordonnees_geo);

                    //placer la station courante sur la carte
                    /*
                    let marker = L.marker([lon, lat])
                    .addTo(map)
                    .bindPopup('bindPopup()')
                    .openPopup();
                    */
                    // Créez un popup avec des informations de station.
                    // Créez un popup avec des informations de station.
                    
                    let popupContent = `
                        <strong>Station Information</strong><br>
                        <ul>
                        <li><i class="fas fa-map-marker-alt"></i> Name: ${name}</li>
                        <li><i class="far fa-calendar-check"></i> Due Date: ${duedate}</li>
                        <li><i class="fas fa-users"></i> Capacity: ${capacity}</li>
                        <li><i class="fas fa-parking"></i> Docks Available: ${numdocksavailable}</li>
                        <li><i class="fas fa-bicycle"></i> Bikes Available: ${numbikesavailable}</li>                        
                        <li><i class="fas fa-bolt"></i> E-Bike Available: ${ebike}</li>
                        <li><i class="fas fa-bicycle"></i> Mechanical Bikes: ${mechanical}</li>

                        </ul>
                    `;
                    let marker = L.marker([lat, lon]);
                    marker.bindPopup(popupContent);

                    markers.addLayer(marker); // Ajoutez le marqueur au groupe de clusters.               


                });

  


                // IMPORTANT
                map.addLayer(markers); // Add the cluster group to the map.


            } catch(e) {
                console.error(e);
            }

        };




        // main
        main()
        .then(() => {
                console.log('FIN main');
            }
        ); 


        // Listeners         
        markers.on('clusterclick', function (a) {
            console.log('Cluster Clicked',a); 
        });
        markers.on('click', function (a) {
            console.log('Marker Clicked',a); 
        });        



    </script>


    
</body>
</html>